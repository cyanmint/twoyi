# Twoyi Rust Project (Unified JNI + Server)

This is the unified Rust project for Threetwi, a fork of [twoyi](https://github.com/twoyi/twoyi).

## About

This project builds as **BOTH**:
1. **libtwoyi.so** - JNI library for Android app use (provides OpenGL rendering via libOpenglRender.so)
2. **twoyi-server** - Standalone binary for CLI use (provides headless container with scrcpy display)

The code is shared between both targets, with conditional compilation for Android-specific features.

**Note:** All files in this directory were generated by AI (GitHub Copilot) and are NOT APPLICABLE for copyright.

## Changes from Original Twoyi (since commit d3ce306)

### Version 3.5.8 - Unified Codebase

#### Merged code into app/rs
- Single Rust project that builds both JNI library and standalone server
- Removed separate `server/` directory - all code now in `app/rs/`
- Shared input system, gralloc emulation, and server code
- Conditional compilation separates Android-specific JNI code
- Legacy mode support with `-L` flag for OpenGL rendering

### Version 3.5.7

#### Fixed Profile Switching Container Crashes
- Server correctly uses profile-specific boot files now
- Boot files (dev/input, dev/socket, dev/maps) are created in the correct rootfs directory for each profile
- Prevents crashes when switching between profiles with different rootfs paths

### Version 3.5.6

#### Profile-Specific Rootfs Initialization
- Server now uses profile-specific rootfs directories
- Each profile can have its own isolated container environment
- Automatic rootfs initialization for new profiles

### Version 3.5.5

#### New Server Component
- Complete Rust-based server for headless container operation
- Scrcpy integration for display rendering
- Fake gralloc device for capturing graphics from legacy ROMs
- Input system for touch and keyboard events

#### Profile Support
- Added `--profile` command line argument for profile identification
- Profile name is included in server info response to clients
- Allows running multiple container instances with different configurations

#### Command Line Arguments

```
twoyi-server [OPTIONS]

Options:
  -r, --rootfs <PATH>       Path to the rootfs directory
  -l, --loader <PATH>       Path to the loader library (libloader.so)
  -b, --bind <ADDRESS>      Address and port to bind for control connections (default: 0.0.0.0:8765)
  -a, --adb-address <ADDR>  ADB address and port for scrcpy connections (default: 0.0.0.0:5556)
  -W, --width <WIDTH>       Screen width (default: 1080)
  -H, --height <HEIGHT>     Screen height (default: 1920)
  -d, --dpi <DPI>           Screen DPI (default: 320)
  -v, --verbose <LEVEL>     Verbose level: "none", "v" (default), "vv"
  -s, --setup               Setup mode - start server without launching container
  -P, --patch               Patch ROM binaries for custom rootfs path (run once)
  -p, --profile <NAME>      Profile name for identification (default: "default")
  -L, --legacy              Legacy mode - use OpenGL renderer instead of fake gralloc
  -f, --fps <FPS>           Frames per second for legacy mode (default: 60)
```

#### ROM Binary Patching

The ROM has multiple binary files with hardcoded paths that need to be patched when using a custom rootfs location.

**Files patched:**
- ROM files: `init`, `sbin/charger`, `system/lib64/libc.so`, `system/bin/adbd`, `system/bin/linker64`
- ROM files: `system/bin/mdnsd`, `system/xbin/su`, `system/lib64/libOpenglRender.so`, `system/lib64/libui.so`
- ROM files: `system/vendor/lib64/egl/libEGL_emulation.so`, `system/vendor/lib64/libOpenglSystemCommon.so`
- Loader: `loader64` binary (located outside rootfs)

**Hardcoded paths patched:**
- `/data/data/io.twoyi/rootfs` (26 chars max) - base path
- `/data/data/io.twoyi/loader64` (28 chars max) - loader path
- `/data/data/io.twoyi/loader32` (28 chars max) - loader path
- `/data/data/io.twoyi/rootfs/dev/socket/property_service` (54 chars) - property service socket
- `/data/data/io.twoyi/rootfs/opengles*` (35-36 chars) - OpenGL sockets
- `/data/data/io.twoyi/rootfs/vendor/lib64/egl/libGLES*.so` (66-69 chars) - GLES emulation libs

**In the Android app:** Patching is done automatically during ROM extraction (except loader64, which is shared across profiles).

**For standalone server usage:** Use the `-P` or `--patch` flag to patch all ROM binaries and loader64:

```bash
# Patch the ROM for a custom rootfs path (run once after extracting ROM)
twoyi-server -r /data/ty1 -P

# After patching, run normally without -P
twoyi-server -r /data/ty1
```

**Note:** If your base path exceeds 26 characters, create symlinks to create shorter paths:
```bash
ln -s /data/data/com.termux/files/home/rootfs /data/ty1
twoyi-server -r /data/ty1 -P
```

## Building

```bash
cd app/rs

# Build for Android (creates both libtwoyi.so and twoyi-server)
./build_rs.sh --release

# Build for local testing (Linux x86_64)
cargo build --release
```

## Files

All files in this directory were created by AI (GitHub Copilot) and are NOT APPLICABLE for copyright:

- `src/lib.rs` - Library entry point with JNI bindings (Android-only)
- `src/main.rs` - Main server binary with control connections
- `src/server.rs` - Server logic shared by both library and binary
- `src/framebuffer.rs` - Framebuffer capture and streaming
- `src/gralloc.rs` - Fake gralloc device implementation
- `src/input.rs` - Touch and keyboard input handling
- `src/renderer.rs` - Legacy OpenGL renderer wrapper
- `src/renderer_bindings.rs` - libOpenglRender.so FFI bindings
- `src/rom_patcher.rs` - ROM binary patching utilities
- `Cargo.toml` - Rust package configuration
- `build_android.sh` - Android build script

## License

All code in this directory was generated by AI (GitHub Copilot) and is NOT APPLICABLE for copyright.
Original twoyi code is licensed under MPL-2.0.
